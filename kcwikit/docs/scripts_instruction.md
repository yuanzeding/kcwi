# Command Line Tools

Here is a list of command line tools offered by this package, and their functionalities. 

## kcrm_create_crmsk

```bash
kcrm_create_crmsk filename [-l [LABEL [LABEL ...]]] [--base_dir BASE_DIR] [--redux_dir REDUX_DIR] 
```
This script runs the median cosmic ray rejection and creates the FITS CR masks for each frame.
- `filename` - the input `json` file containing the grouping of frames generated by the `kcrm_group_frames` script. 
- `-l --label` - one or multiple label names in the grouping `json` file of which the CR masks are created. If no label is specified, all labels are created. 
- `--base_dir` - directory to which the raw frames are stored. Default is `./`.
- `--redux_dir` - diretory to which the redux directory is created by the DRP. Default is `./redux`.

## kcrm_group_frames

```bash
kcrm_group_frames logfile outfile [-c] [-d] [-i] [--redux_dir REDUX_DIR]
```
This script groups the individual frames based on the target names, PA, instrument setup, and exposure times. This grouping is stored in a `json` file to be used for cosmic ray rejction. 
- `logfile` - the `csv` file generated by `kcwi_gen_log`, containing the header information for all the frames. 
- `outfile` - the file name of the output `json` file. 
- `-c --continuous` - split non-continuous files into seperate groups. 
- `-d --display` - print out the grouping.
- `-i --int` - check if the `*_int.fits` exists in the `redux` directory
- `--redux_dir` - location of the redux directory created by the DRP. Default is `./redux`

## kcwi_collapse

```bash
kcwi_collapse file [file ...] [--wavebin WAVEBIN WAVEBIN] [--usepix]
```
Create white-light image from data cube(s). 
- `file` - file name(s) to be acted on. 
- `--wavebin` - the lower and upper wavelength limits in Angstrom.
- `--usepix` - change the unit of the previous `wavebin` parameter to pixel index. 

## kcwi_combinestd

```bash
kcwi_combinestd listfile [--noplot]
```
Combining a series of inverse sensitivity curves generated from multiple standard stars or standard star exposures. Often used to achieve higher accuracy (~3.5%) in flux calibration. 
- `listfile` - an ASCII list containing the absolute path and the full file names of the `invsens` files generated by the DRP or `KSkyWizard`. 
- `--noplot` - avoid creating the bokeh figure. 

## kcwi_flatten_cube

```bash
kcwi_flatten_cube file [file ...] [-r] [-m] [-t]
```
Flatten or de-flatten a FITS cube. Created from `kcwi_flatten_cube.pro` in the IDL DRP.
- `file` - file name(s) of the FITS cubes. 
- `-r --reverse` - reverse the flattening, i.e., building a cube from the 2D flattened image
- `-m --mask` - conduct the flattening or deflattening on a mask cube. 
- `-t --trim` - the amount pixels to be trimmed on top and bottom of the cube. 

## kcwi_gen_log
```bash
kcwi_gen_log outfile -f [FILENAME [FILENAME ...]] [-r] [-b] [-d]
```
Generate a `csv` file containing the important header information of FITS files. 
- `outfile` - name of the output file
- '-f --filename' - name(s) of the FITS files
- '-r --RED' - only perform on the red channel data
- '-b --BLUE' - only perform on the blue channel data
- '-d --display' - print the table

## kcwi_makemask
```bash
kcwi_makemask [dir]
```
Generate FITS masks from then DS9 region files for sky subtraction. This script is a wrapper for `kcwi_masksky_ds9`. 
- `dir` - diretory of which all `*.reg` will be converted. Default is `./`.

## kcwi_makemask_medfilter
```bash
kcwi_makemask_medfilter [dir] [-d]
```
Generate FITS masks from then DS9 region files for median filtering only. This script is a wrapper for `kcwi_masksky_ds9_thum` and `kcwi_masksky_ds9_2d`. 
- `dir` - diretory of which all `*.thum.reg` and `*_icube_2d.reg` will be converted. Default is `./`.
- `-d --cubed` - act on `cubed` files. 

## kcwi_masksky_ds9_2d
```bash
kcwi_masksky_ds9_2d [imagename] [regionname]
```
Generate median filter masks from region files for the flatten cube. 
- `imagename` - name of the `_2d.fits` file generated by `kcwi_flatten_cube`.
- `regionname` - name of the `region` file created from `ds9`.

## kcwi_masksky_ds9_thum
```bash
kcwi_masksky_ds9_thum [imagename] [regionname]
```
Generate median filter masks from region files for the white light image. 
- `imagename` - name of the `_thum.fits` file generated by `kcwi_collapse`.
- `regionname` - name of the `region` file created from `ds9`.

## kcwi_masksky_ds9_zap
```bash
kcwi_masksky_ds9_zap [imagename] [regionname]
```
Generate binary mask for KSkyWizard.
- `imagename` - name of the `_wlimg.fits` generated by KSkyWizard.
- `regionname` - name of the `region` file created from `ds9` (optional if named as `<prefix>_<image number>.reg`).

## kcwi_masksky_ds9
```bash
kcwi_masksky_ds9 [imagename] [regionname]
```
Generate binary masks for DRP sky subtraction from region files. This is copied from the offical DRP. 
- `imagename` - name of the FITS file. They can be `*_intf.fits` or `*_intk.fits`.
- `regionname` - name of the `region` file created from `ds9`.

## kcwi_medfilter
```bash
kcwi_medfilter file [file ...] [-p PARFN] [--zbin ZBIN] [--ybin YBIN] [--ytrim YTRIM] [--override] [--nproc NPROC]
```
Conduct median filtering and subtract the median-filtered background. 
- `file` - file name(s) of the frame(s) to be subtracted. 
- `-p --par` - name of the parameter file (see below for setting up this file).  
- `--zbin` - window size in the z-direction. 
- `--ybin` - window size in the y-direction. 
- `--ytrim` - number of pixels to be trimmed on the edge. 
- `--override` - act on processed file. 
- `--nproc` - number of processors for parallelization.

<details>
<summary> Setting up the parameter file.  </summary>

Using default parameters do not require to set up a parameter file. However, if you prefer to modify certain parameters for single files, but still wish to run the files in batch, you may set up a parameter file. Below is an example with the default parameters.
```
FN = kb200616_00053     # file name prefix
ZBIN = 100              # binning size (pixel) in the wavelength direction
YBIN = 16               # binning size (pixel) in the y direction
YTRIM = 4               # number of pixels to trim on the top and bottom of the slicer 
BKGTYPE = 0             # set 1 to skip this frame 
```
Additional frames can be appended below. 

</details>



